CREATE TABLE IF NOT EXISTS `old_entity` ( id int NOT NULL PRIMARY KEY AUTO_INCREMENT, BIN VARCHAR(1000) DEFAULT NULL, name_kk VARCHAR(1000) DEFAULT NULL, name_ru VARCHAR(1000) DEFAULT NULL, register_date VARCHAR(1000) DEFAULT NULL, economic_activity_code VARCHAR(1000) DEFAULT NULL, activity_kk VARCHAR(1000) DEFAULT NULL, activity_ru VARCHAR(1000) DEFAULT NULL, economic_activity_codes VARCHAR(1000) DEFAULT NULL, company_size_code VARCHAR(1000) DEFAULT NULL, size_kk VARCHAR(1000) DEFAULT NULL, size_ru VARCHAR(1000) DEFAULT NULL, territory_code VARCHAR(1000) DEFAULT NULL, locality_kk VARCHAR(1000) DEFAULT NULL, locality_ru VARCHAR(1000) DEFAULT NULL, address VARCHAR(1000) DEFAULT NULL, CEO VARCHAR(1000) DEFAULT NULL, active int(5) DEFAULT NULL, resident int(5) DEFAULT NULL);
CREATE TABLE IF NOT EXISTS `old_branche` (id int NOT NULL PRIMARY KEY AUTO_INCREMENT,BIN VARCHAR(1000) DEFAULT NULL,head_BIN VARCHAR(1000) DEFAULT NULL);
CREATE TEMPORARY TABLE `old_entity_temp` ( `BIN` varchar(12) NOT NULL DEFAULT '', `name_kk` varchar(1000) DEFAULT NULL, `name_ru` varchar(1000) DEFAULT NULL, `register_date` date DEFAULT NULL, `economic_activity_code` varchar(5) DEFAULT NULL COMMENT 'ОКЭД', `activity_kk` varchar(1000) DEFAULT NULL COMMENT 'Основной вид деятельности', `activity_ru` varchar(1000) DEFAULT NULL COMMENT 'Основной вид деятельности', `economic_activity_codes` varchar(2000) DEFAULT NULL COMMENT 'ОКЭД второстепенные', `company_size_code` int(11) DEFAULT NULL COMMENT 'КРП', `size_kk` VARCHAR(1000) DEFAULT NULL COMMENT 'Размер предприятия', `size_ru` VARCHAR(1000) DEFAULT NULL COMMENT 'Размер предприятия', `territory_code` varchar(9) DEFAULT NULL COMMENT 'КАТО', `locality_kk` VARCHAR(1000) DEFAULT NULL COMMENT 'Наименование населенного пункта', `locality_ru` VARCHAR(1000) DEFAULT NULL COMMENT 'Наименование населенного пункта', `address` varchar(1000) DEFAULT NULL, `resident` tinyint(1) NOT NULL DEFAULT 1 COMMENT 'Резиденство', `active` tinyint(1) NOT NULL DEFAULT 0, `CEO` varchar(1000)  DEFAULT NULL COMMENT 'Первый руководитель' ) DEFAULT CHARSET=utf8;
CREATE TEMPORARY TABLE `old_branche_temp` (   `BIN` varchar(12) NOT NULL COMMENT 'БИН филлиала',   `head_BIN` varchar(12) NOT NULL COMMENT 'БИН головного предприятия' ) DEFAULT CHARSET=utf8;
LOAD DATA LOCAL INFILE 'interprises_parsers/tmp/old_entity.csv' IGNORE INTO TABLE old_entity_temp FIELDS TERMINATED BY '\t' ENCLOSED BY '"' ESCAPED BY '\\' LINES TERMINATED BY '\n' IGNORE 1 LINES ( BIN, name_kk, name_ru, register_date, economic_activity_code, activity_kk, activity_ru, economic_activity_codes, company_size_code, size_kk, size_ru, territory_code, locality_kk, locality_ru, address, CEO, active, resident);
LOAD DATA  LOCAL INFILE 'interprises_parsers/tmp/old_branche.csv' IGNORE INTO TABLE old_branche_temp FIELDS TERMINATED BY '\t'  ENCLOSED BY '"' ESCAPED BY '\\' LINES TERMINATED BY '\n' IGNORE 1 LINES (BIN, head_BIN);
UPDATE old_entity SET active = 0;
INSERT INTO old_entity ( BIN, name_kk, name_ru, register_date, economic_activity_code, activity_kk, activity_ru, economic_activity_codes, company_size_code, size_kk, size_ru, territory_code, locality_kk, locality_ru, address, CEO,  active, resident) SELECT  BIN, name_kk, name_ru, register_date, economic_activity_code, activity_kk, activity_ru, economic_activity_codes, company_size_code, size_kk, size_ru, territory_code, locality_kk, locality_ru, address, CEO, active, resident FROM old_entity_temp ON DUPLICATE KEY UPDATE   name_kk = VALUES(name_kk), name_ru = VALUES(name_ru), economic_activity_code = VALUES(economic_activity_code), activity_kk = VALUES(activity_kk), activity_ru = VALUES(activity_ru), economic_activity_codes = VALUES(economic_activity_codes), company_size_code = VALUES(company_size_code), size_kk = VALUES(size_kk), size_ru = VALUES(size_ru), territory_code = VALUES(territory_code), locality_kk = VALUES(locality_kk), locality_ru = VALUES(locality_ru), address = VALUES(address), resident = VALUES(resident), active = VALUES(active), CEO = VALUES(CEO);
INSERT INTO old_branche (BIN, head_BIN) SELECT BIN, head_BIN FROM old_branche_temp ON DUPLICATE KEY UPDATE head_BIN=VALUES(head_BIN);